name: Deploy Branch to GitHub Pages
description: "Deploy a branch making a PR to main to GitHub Pages to test the changes in a live github pages environment"

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy"
        required: true
        default: ""

permissions:
  pull-requests: write
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    defaults:
      run:
        working-directory: ./shesha-reactjs
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'shesha-reactjs/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Verify build output
        run: |
          echo "Build directory contents:"
          ls -la dist/ || echo "dist directory not found"
          echo "Number of files in dist:"
          find dist -type f | wc -l || echo "Could not count files"

      - name: Create deployment structure
        run: |
          cd ..  # Go back to repo root
          
          # Get branch name (works for both PR and manual dispatch)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.event.inputs.branch }}"
          fi
          
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
          
          echo "Deploying branch: $BRANCH_NAME as $SAFE_BRANCH_NAME"
          
          # Create site structure
          mkdir -p _site/branches/$SAFE_BRANCH_NAME
          
          # Copy build files
          if [ -d "shesha-reactjs/dist" ] && [ "$(ls -A shesha-reactjs/dist)" ]; then
            cp -r shesha-reactjs/dist/* _site/branches/$SAFE_BRANCH_NAME/
            echo "Copied files from shesha-reactjs/dist/"
          else
            echo "Error: shesha-reactjs/dist is empty or doesn't exist"
            echo "Creating fallback page..."
            echo "<h1>Build Error</h1><p>No build output found for branch: $BRANCH_NAME</p>" > _site/branches/$SAFE_BRANCH_NAME/index.html
          fi
          
          # Create main index page
          cat > _site/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>Branch Deployments - Shesha Framework</title>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { 
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  .container { 
                      max-width: 900px; 
                      margin: 0 auto; 
                      background: white;
                      border-radius: 20px;
                      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                      overflow: hidden;
                  }
                  .header {
                      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                      color: white;
                      padding: 40px;
                      text-align: center;
                  }
                  .header h1 { 
                      font-size: 2.5rem; 
                      margin-bottom: 10px;
                      font-weight: 700;
                  }
                  .header p { 
                      opacity: 0.9; 
                      font-size: 1.1rem;
                  }
                  .content { padding: 40px; }
                  .branch { 
                      margin: 20px 0; 
                      padding: 25px; 
                      border: 1px solid #e1e5e9;
                      border-radius: 12px;
                      transition: all 0.3s ease;
                      background: #fafbfc;
                  }
                  .branch:hover { 
                      transform: translateY(-2px);
                      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                      border-color: #667eea;
                  }
                  .branch h3 { 
                      color: #2d3748; 
                      margin-bottom: 12px;
                      font-size: 1.3rem;
                      display: flex;
                      align-items: center;
                  }
                  .branch-icon {
                      width: 20px;
                      height: 20px;
                      margin-right: 12px;
                      color: #667eea;
                  }
                  .branch a { 
                      color: white; 
                      text-decoration: none;
                      font-weight: 600;
                      display: inline-flex;
                      align-items: center;
                      padding: 12px 20px;
                      background: #667eea;
                      border-radius: 8px;
                      transition: background 0.3s ease;
                  }
                  .branch a:hover { 
                      background: #5a67d8;
                  }
                  .meta { 
                      color: #718096; 
                      font-size: 0.9rem;
                      margin-top: 12px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ðŸš€ Shesha Framework</h1>
                      <p>Branch Preview Deployments</p>
                  </div>
                  <div class="content">
                      <div class="branch">
                          <h3>
                              <svg class="branch-icon" fill="currentColor" viewBox="0 0 20 20">
                                  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                              </svg>
                              $BRANCH_NAME
                          </h3>
                          <a href="./branches/$SAFE_BRANCH_NAME/" target="_blank">View Deployment â†’</a>
                          <div class="meta">Updated: $(date '+%B %d, %Y at %H:%M UTC')</div>
                      </div>
                  </div>
              </div>
          </body>
          </html>
          EOF
          
          echo "Final _site structure:"
          find _site -type f | head -10

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const safeBranchName = branchName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
            const baseUrl = '${{ steps.deployment.outputs.page_url }}';
            const deployUrl = `${baseUrl}branches/${safeBranchName}/`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Branch Preview Deployed!**\n\n**Your branch:** [${branchName}](${deployUrl})\n**All deployments:** [View Index](${baseUrl})\n\n*This preview updates automatically with new commits to this PR.*`
            });